<html>
	<head>
             	<script src="cssParser.js"></script>
		<script src="underscore-min.js"></script>
        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

		<script>
function generateGraphic() {

    var source = '';

    var source = document.getElementById('source').value;

    var parser = new CSSParser();
    var sheet = parser.parse(source, false, true);

    var files = [];
    var key = 'No file';
    var selectorcount = 0;
    var rulecount = 0;
    var lastFileName = 0;
    var filename = 0;
    for (var i=0;i<(sheet.cssRules.length);i++) {

        var element = sheet.cssRules[i];

        if (typeof  element.media !== 'undefined') {
            //aller dans les enfants pour les mÃ©dias (cssRules?)
            continue;
        }

        if (typeof  element.error !== 'undefined') {
            continue;
        }

        if (element.parsedCssText.search(/@font-face/) !== -1) {
            continue;
        }

        var countInElement = 0;
        if (typeof  element.mSelectorText !== 'undefined') {
            countInElement = element.mSelectorText.split(',').length;
        }

        selectorcount += countInElement;
        rulecount++;

        var isComment = typeof element.mSelectorText === 'undefined';

        var isNewFile = false;

        if (isComment) {
            var endOfComment = element.parsedCssText.split(',')[1];
            if (typeof endOfComment !== 'undefined') {
                filename = endOfComment.substring(0, endOfComment.length-3);
                isNewFile = filename !== lastFileName;
            }
        }

        var isLast = (i == sheet.cssRules.length-1);
        if (isNewFile || isLast) {
            files.push({
                selectorcount: selectorcount,
                rulescount: rulecount,
                name: lastFileName
            });
            key = element.parsedCssText;
            selectorcount = 0;
            rulecount = 0;
        }

        lastFileName = filename;
    }

    var root = {
        "name": "test",
        "children": files
    };


    var margin = {top: 40, right: 10, bottom: 10, left: 10},
            width = 960 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

    var color = d3.scale.category20c();

    var treemap = d3.layout.treemap()
            .size([width, height])
            .sticky(true)
            .value(function(d) { return d.selectorcount; });

    d3.select("#graphic-container > div").remove();

    var div = d3.select("#graphic-container").append("div")
            .style("position", "relative")
            .style("width", (width + margin.left + margin.right) + "px")
            .style("height", (height + margin.top + margin.bottom) + "px")
            .style("left", margin.left + "px")
            .style("top", margin.top + "px");

    var node = div.datum(root).selectAll(".node")
            .data(treemap.nodes)
            .enter().append("div")
            .attr("class", "node")
            .call(position)
            .style("background", function(d) { return d.children ? color(d.name) : null; })
            .text(function(d) { return d.children ? null : d.name; });

    d3.selectAll("input").on("change", function change() {
        var value = this.value === "selectorcount"
                ? function(d) { return d.selectorcount; }
                : function(d) { return d.rulescount; };

        node
                .data(treemap.value(value).nodes)
                .transition()
                .duration(1500)
                .call(position);
    });
    //});

    function position() {
        this.style("left", function(d) { return d.x + "px"; })
                .style("top", function(d) { return d.y + "px"; })
                .style("width", function(d) { return Math.max(0, d.dx - 1) + "px"; })
                .style("height", function(d) { return Math.max(0, d.dy - 1) + "px"; });
    }
}

		</script>

	</head>
	<body>
    <style>

        body {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            margin: auto;
            position: relative;
            width: 960px;
        }

        form {
            position: absolute;
            right: 10px;
            top: 10px;
        }

        .node {
            border: solid 1px white;
            font: 10px sans-serif;
            line-height: 12px;
            overflow: hidden;
            position: absolute;
            text-indent: 2px;
        }

    </style>
    <form>
        <label><input type="radio" name="mode" value="selectorcount" checked> Number of selectors</label>
        <label><input type="radio" name="mode" value="rulecount">Number of rules</label>
    </form>


    <div id="graphic-container">

    </div>

    <textarea id="source" style="width: 100%;height: 180px">
        body, div, span { font: 2em sans-serif; } a { color: green; } /* test */ p, div, span { color:red }
    </textarea>

    <input type="button" id="update-graphic" onclick="generateGraphic();" value="Update"/>

    <script>


        generateGraphic();


    </script>
	</body>
</html>

